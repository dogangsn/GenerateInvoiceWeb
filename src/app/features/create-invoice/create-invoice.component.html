<div class="flex h-screen overflow-hidden bg-slate-50">
    <!-- Left Side: Form -->
    <div class="w-1/2 h-full overflow-y-auto border-r border-slate-200 bg-white p-8">
        <div class="max-w-2xl mx-auto space-y-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Yeni Fatura Oluştur</h1>
                    <!-- Seçili Ülke Bilgisi -->
                    <div *ngIf="selectedCountry" class="flex items-center gap-2 mt-2 text-sm text-slate-500">
                        <span class="text-lg">{{ selectedCountry.flag }}</span>
                        <span>{{ selectedCountry.name }}</span>
                        <span class="text-slate-300">|</span>
                        <span class="font-medium">{{ selectedCountry.currency.code }}</span>
                    </div>
                </div>
                <app-button variant="ghost" icon="arrow_back" (click)="goBack()">Ülke Değiştir</app-button>
            </div>

            <!-- Fatura Bilgileri -->
            <section class="space-y-4">
                <h2 class="text-lg font-bold text-slate-900 border-b border-slate-100 pb-2">Fatura Bilgileri</h2>
                <div class="grid grid-cols-2 gap-4">
                    <app-input label="Fatura Tipi" placeholder="Satış" [disabled]="true"></app-input>
                    <app-input label="Fatura Senaryosu" placeholder="Temel Fatura" [disabled]="true"></app-input>
                    <app-input label="Fatura Tarihi" type="date"
                        [formControl]="$any(invoiceForm.get('date'))"></app-input>
                    <app-input label="Fatura Saati" type="time"
                        [formControl]="$any(invoiceForm.get('time'))"></app-input>
                </div>
            </section>

            <!-- Müşteri Bilgileri -->
            <section class="space-y-4">
                <h2 class="text-lg font-bold text-slate-900 border-b border-slate-100 pb-2">Müşteri Bilgileri</h2>
                <app-input label="Müşteri Adı / Ünvanı" placeholder="Müşteri adını girin"
                    [formControl]="$any(invoiceForm.get('customerName'))"></app-input>
                <div class="grid grid-cols-2 gap-4">
                    <app-input [label]="selectedCountry?.taxIdLabel || 'Vergi Numarası'" 
                        [placeholder]="'Örn: ' + (selectedCountry?.taxIdFormat || '')"
                        [formControl]="$any(invoiceForm.get('taxId'))"></app-input>
                    <app-input label="Adres" placeholder="Müşteri adresini girin"
                        [formControl]="$any(invoiceForm.get('address'))"></app-input>
                </div>
            </section>

            <!-- Vergi Ayarları -->
            <section class="space-y-4" *ngIf="selectedCountry">
                <h2 class="text-lg font-bold text-slate-900 border-b border-slate-100 pb-2">
                    Vergi Ayarları ({{ selectedCountry.name }})
                </h2>
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Vergi Türü</label>
                        <select (change)="onTaxRateChange($event)"
                            class="w-full bg-white rounded-lg border-slate-300 text-sm py-2 px-3 focus:border-primary focus:ring-1 focus:ring-primary">
                            <option *ngFor="let tax of availableTaxRates" [value]="tax.rate" [selected]="tax.isDefault">
                                {{ tax.name }} - %{{ tax.rate }}
                            </option>
                        </select>
                    </div>
                    <div class="w-32 text-center">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Seçili Oran</label>
                        <div class="text-2xl font-bold text-primary">%{{ selectedTaxRate?.rate || 0 }}</div>
                    </div>
                    <div class="w-24 text-center">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Para Birimi</label>
                        <div class="text-xl font-bold text-slate-700">{{ selectedCountry.currency.symbol }}</div>
                    </div>
                </div>
            </section>

            <!-- Fatura Kalemleri -->
            <section class="space-y-4">
                <h2 class="text-lg font-bold text-slate-900 border-b border-slate-100 pb-2">Fatura Kalemleri</h2>

                <div class="space-y-4">
                    <div *ngFor="let item of items.controls; let i = index" [formGroup]="$any(item)"
                        class="flex gap-3 items-start p-4 bg-slate-50 rounded-lg border border-slate-200 group">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Açıklama</label>
                            <input type="text" formControlName="description"
                                class="w-full rounded border-slate-300 text-sm" placeholder="Ürün/Hizmet adı">
                        </div>
                        <div class="w-20">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Miktar</label>
                            <input type="number" formControlName="quantity"
                                class="w-full rounded border-slate-300 text-sm">
                        </div>
                        <div class="w-28">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Birim Fiyat ({{ selectedCountry?.currency?.symbol }})</label>
                            <input type="number" formControlName="unitPrice"
                                class="w-full rounded border-slate-300 text-sm">
                        </div>
                        <div class="w-28 pt-6 text-right font-medium text-slate-900">
                            {{ selectedCountry?.currency?.symbol }}{{ (item.get('quantity')?.value * item.get('unitPrice')?.value) | number:'1.2-2' }}
                        </div>
                        <button (click)="removeItem(i)" class="mt-6 text-slate-400 hover:text-red-600"
                            [disabled]="items.length === 1">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>

                <button (click)="addItem()"
                    class="flex items-center gap-2 text-primary font-bold hover:text-blue-700 text-sm">
                    <span class="material-symbols-outlined text-lg">add_circle</span>
                    Yeni Kalem Ekle
                </button>
            </section>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-4 pt-8 border-t border-slate-200 print:hidden">
                <app-button variant="secondary" (click)="saveDraft()" [disabled]="isSaving">
                    {{ isSaving ? 'Kaydediliyor...' : 'Taslak Olarak Kaydet' }}
                </app-button>
                <app-button variant="primary" (click)="printInvoice()" [disabled]="isSaving">
                    <span class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">print</span>
                        Yazdır / PDF
                    </span>
                </app-button>
            </div>
        </div>
    </div>

    <!-- Right Side: Preview -->
    <div class="w-1/2 h-full bg-slate-100 p-8 overflow-y-auto flex justify-center items-start">
        <!-- A4 Paper -->
        <div
            class="w-full max-w-[210mm] aspect-[210/297] bg-white shadow-2xl p-[10mm] md:p-[20mm] text-slate-900 text-sm relative">
            <!-- Header -->
            <div class="flex justify-between items-start mb-12">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">Şirket Adınız</h2>
                    <p class="text-slate-500 text-xs">{{ selectedCountry?.taxIdLabel }}: 1234567890</p>
                    <p class="text-slate-500 text-xs">{{ selectedCountry?.name }}</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center justify-end gap-2 mb-2">
                        <span class="text-2xl">{{ selectedCountry?.flag }}</span>
                    </div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-widest mb-4">FATURA</h1>
                    <div class="text-xs space-y-1">
                        <p><span class="font-bold text-slate-700">Fatura No:</span> {{ selectedCountry?.invoicePrefix }}-00123</p>
                        <p><span class="font-bold text-slate-700">Tarih:</span> {{ invoiceForm.get('date')?.value |
                            date: selectedCountry?.dateFormat || 'dd/MM/yyyy' }}</p>
                    </div>
                </div>
            </div>

            <!-- Client Info -->
            <div class="mb-12 border-b border-slate-200 pb-8">
                <h3 class="font-bold text-slate-900 mb-2">Sayın:</h3>
                <p class="text-lg font-medium">{{ invoiceForm.get('customerName')?.value || 'Müşteri Adı' }}</p>
                <p class="text-slate-500">{{ invoiceForm.get('address')?.value || 'Adres bilgisi girilmedi' }}</p>
                <p class="text-slate-500 mt-1" *ngIf="invoiceForm.get('taxId')?.value">
                    {{ selectedCountry?.taxIdLabel }}: {{ invoiceForm.get('taxId')?.value }}
                </p>
            </div>

            <!-- Items Table -->
            <table class="w-full mb-8">
                <thead>
                    <tr class="border-b-2 border-slate-900 text-xs uppercase tracking-wider">
                        <th class="text-left py-3">Açıklama</th>
                        <th class="text-right py-3 w-20">Miktar</th>
                        <th class="text-right py-3 w-32">Birim Fiyat</th>
                        <th class="text-right py-3 w-32">Toplam</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    <tr *ngFor="let item of items.controls">
                        <td class="py-4">{{ item.get('description')?.value || '-' }}</td>
                        <td class="text-right py-4">{{ item.get('quantity')?.value }}</td>
                        <td class="text-right py-4">{{ selectedCountry?.currency?.symbol }}{{ item.get('unitPrice')?.value | number:'1.2-2' }}</td>
                        <td class="text-right py-4 font-medium">{{ selectedCountry?.currency?.symbol }}{{ (item.get('quantity')?.value * item.get('unitPrice')?.value) | number:'1.2-2' }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- Totals -->
            <div class="flex justify-end">
                <div class="w-72 space-y-3">
                    <div class="flex justify-between text-slate-600">
                        <span>Ara Toplam:</span>
                        <span>{{ selectedCountry?.currency?.symbol }}{{ calculateSubtotal() | number:'1.2-2' }}</span>
                    </div>
                    <div class="flex justify-between text-slate-600">
                        <span>{{ selectedTaxRate?.name }} (%{{ selectedTaxRate?.rate }}):</span>
                        <span>{{ selectedCountry?.currency?.symbol }}{{ calculateTax() | number:'1.2-2' }}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-slate-900 border-t border-slate-900 pt-3">
                        <span>Genel Toplam:</span>
                        <span>{{ selectedCountry?.currency?.symbol }}{{ calculateTotal() | number:'1.2-2' }}</span>
                    </div>
                </div>
            </div>

            <!-- Footer Note -->
            <div class="absolute bottom-[20mm] left-[20mm] right-[20mm] text-center text-xs text-slate-400">
                Ödemeleriniz için teşekkür ederiz. Sorularınız için bizimle iletişime geçebilirsiniz.
            </div>
        </div>
    </div>
</div>